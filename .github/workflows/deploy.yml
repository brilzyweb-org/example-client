name: Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Позволяет запускать вручную через GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Setup SSH for VPS
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "⚠️ VPS secrets not configured, skipping SSH setup"
            exit 0
          fi
          mkdir -p ~/.ssh
          # Сохраняем SSH ключ (GitHub Secrets автоматически сохраняют переносы строк)
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Проверяем формат ключа перед использованием
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "❌ Invalid SSH key format. Check VPS_SSH_KEY secret."
            echo "Key should start with: -----BEGIN OPENSSH PRIVATE KEY-----"
            exit 1
          fi
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # Запускаем ssh-agent для автоматического использования ключа
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
      
      - name: Deploy (CDN + VPS)
        run: npm run deploy:all
        env:
          # GitHub API для CDN репозитория (из Organization Secrets)
          GITHUB_TOKEN: ${{ secrets.CDN_GITHUB_TOKEN }}
          CDN_REPO: ${{ secrets.CDN_REPO }}
          CDN_BRANCH: ${{ secrets.CDN_BRANCH || 'main' }}
          
          # VPS настройки (из Organization Secrets)
          # projectId определяется автоматически из agency-config.json в deploy.js
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_WORKER_PATH: ${{ secrets.VPS_WORKER_PATH }}